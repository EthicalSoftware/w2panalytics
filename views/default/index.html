{{extend 'layout.html'}}
<div role="tabpanel">

  <!-- Nav tabs -->
  <ul class="nav nav-tabs" role="tablist">
    <li role="presentation" ><a href="#mappa" aria-controls="mappa" role="tab" data-toggle="tab">Mappa</a></li>
    {{if request.vars.dev:}}
    <li role="presentation" class=""><a href="#grafici" role="tab" data-toggle="tab">Grafici</a></li>
    <li role="presentation" class="active"><a href="#punchcard" role="tab" data-toggle="tab">Punchcard</a></li>
    {{pass}}
    <!--li role="presentation"><a href="#dati" aria-controls="punchcard" role="tab" data-toggle="tab">Dati</a></li-->
  </ul>

  <!-- Tab panes -->
  <div class="container-fluid box">
  <div class="tab-content row">
      <div role="tabpanel" class="tab-pane container-fluid" id="mappa">
            <div class="map-cont box row">
            <div class="col-md-9">
                <div id="map" style="height: 500px"></div>
            </div>
            <div class="col-md-3">
            <img src="http://geodata.integreen-life.bz.it/geoserver/edi/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=40&HEIGHT=40&LAYER=edi:cleanroads_stations"/>
            </div>
            </div>
      </div>      
      <div role="tabpanel" class="tab-pane active" id="punchcard">
          {{include 'default/punchcard.html'}}
      </div>
      <div role="tabpanel" class="tab-pane " id="grafici">
        <div class="row">
            <div id="reportrange" class="pull-right" style="background: #fff; cursor: pointer; padding: 5px 10px; margin-right:15px;border: 1px solid #ccc">
                <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>
                <span></span> <b class="caret"></b>
            </div>
            <div id='select_data' class="col-md-5">{{=LOAD('data','get_stations', ajax=False, vars={'tab':'grafici'})}}</div>
            <a id='loading' class="btn bnt-info col-md-2">Caricamento...</a>
            <a id='empty' class="btn bnt-alert col-md-2">Nessun dato nell'intervallo selezionato</a>
        </div>
        <div class="container-fluid data-content">
            <div class='row'>
                    <div class="col-md-2 panel-group sidebar_grafici sidebar" id='sidebar_grafici'>
                    </div>
                    <div class='col-md-10' id='chart_space'>
                    <div id="grafici_chart"  style="height:370px"> </div>
                    </div>
            </div>
        </div>
      </div>
      <div role="tabpanel " class="tab-pane" id="dati">
          
      </div>            
  </div>
  </div>
</div>
<script>
    $.web2py.trap_form("", 'select_data');
    $.web2py.trap_form("", 'select_data2');
    $.web2py.ajax_init('');
    $(document).on('shown.bs.tab','body a[data-toggle="tab"]', function() { 
        map.invalidateSize(false);
    });
    url_get_data = '{{=URL("data", "get_data.json")}}'
    timezoneJS.timezone.zoneFileBasePath = '{{=URL('vtraffic', 'static/js', 'tz')}}';
    var options_console = { 
        xaxis: { 
		    mode: "time", timezone: "Europe/Rome", alignTicksWithAxis:true,
		    dayNames: ['{{=T('Sun')}}', '{{=T('Mon')}}', '{{=T('Tue')}}', '{{=T('Wen')}}', '{{=T('Thu')}}', '{{=T('Fri')}}', '{{=T('Sat')}}'] 
	    },
	    yaxis: { position: 'left', zoomRange: false, panRange: false,},
	    addDynamically: true,
	    series:{ lines: { show: true, fill: false },
			     points: { show: true },
			     bars: {show: false},
	    },
	    crosshair: { mode: "x" },
    }
    var plot_console = new lplot('grafici_chart', options_console);
    var reload_interval;
    var map = L.map('map').setView([46.070091, 11.119763], 10);
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    var l_cleanroads = L.tileLayer.betterWms("{{=URL('default', 'wms')}}", {
        layers: 'edi:cleanroads_stations',
        transparent: true,
        attribution: "",
        format: 'image/png',
    }).addTo(map);
    

    var date_set = function(start, end) {
        $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
        startDate = start;
        endDate = end;
        plot_console.reload_all(startDate.unix(), endDate.unix());
    }
    pickler = $('#reportrange').daterangepicker(datapickler_option, date_set);
    $('#reportrange span').html(moment().subtract('days', 29).format('MMMM D, YYYY') + ' - ' + moment().format('MMMM D, YYYY'));

    $("#loading").hide();
    $('#empty').hide();
    $('#grafici_chart').on('loaded', function() {
        //$('#empty').hide();
        $('#loading').fadeOut();
        $('body').css("cursor", "auto");
    });

    $('#grafici_chart').on('empty', function() {
        $("#loading").hide();
        $('#empty').fadeIn();
        $('body').css("cursor", "auto");
    });

    $('#grafici_chart').on('loading', function() {
        $('#empty').hide();
        $('#loading').fadeIn();
        $('body').css("cursor", "progress");
    });
    
    $('#grafici_chart').on('plotted', function() {
        $('#empty').hide();
        $("#loading").hide();
    });


    // Avoid to insert the same station two times
    $(document).on('click', '.tab-pane .form-inline .btn-success', function(e){
        form = $(this).parents('form')[0];
        tab_id  = $($(this).parents('.tab-pane')[0]).attr('id');
        val = $('select', form).find(":selected").val();
        obj = $('#' + tab_id + '_list_' +val);
        if ((! val) || (obj.length) ){
            e.preventDefault()
            e.stopImmediatePropagation();
            fix_dynamic_accordion('#sidebar_console');
            obj.addClass('in');
        }
    });

</script>
